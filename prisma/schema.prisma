generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Tenant {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  memberships    Membership[]
  incidents      Incident[]
  featureFlags   FeatureFlag[]
  auditLogs      AuditLog[]

  @@map("tenants")
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String
  passwordHash  String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  memberships        Membership[]
  createdIncidents   Incident[]       @relation("CreatedIncidents")
  assignedIncidents  Incident[]       @relation("AssignedIncidents")
  timelineEvents     TimelineEvent[]
  auditLogs          AuditLog[]

  @@map("users")
}

model Membership {
  id        String   @id @default(cuid())
  userId    String
  tenantId  String
  role      Role     @default(VIEWER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@map("memberships")
}

enum Role {
  ADMIN
  ENGINEER
  VIEWER
}

model Incident {
  id          String           @id @default(cuid())
  title       String
  severity    Severity
  status      IncidentStatus   @default(OPEN)
  service     String
  environment Environment
  createdById String
  assigneeId  String?
  tenantId    String
  tags        String[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  createdBy User            @relation("CreatedIncidents", fields: [createdById], references: [id])
  assignee  User?           @relation("AssignedIncidents", fields: [assigneeId], references: [id])
  tenant    Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  timeline  TimelineEvent[]
  attachments Attachment[]

  @@index([tenantId, status])
  @@index([tenantId, severity])
  @@index([tenantId, service])
  @@map("incidents")
}

enum Severity {
  SEV1
  SEV2
  SEV3
  SEV4
}

enum IncidentStatus {
  OPEN
  MITIGATED
  RESOLVED
}

enum Environment {
  DEV
  STAGING
  PROD
}

model TimelineEvent {
  id         String   @id @default(cuid())
  incidentId String
  userId     String
  type       EventType
  content    String
  metadata   Json?
  createdAt  DateTime @default(now())

  incident Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id])

  @@map("timeline_events")
}

enum EventType {
  NOTE
  ACTION
  STATUS_CHANGE
}

model Attachment {
  id         String   @id @default(cuid())
  incidentId String
  filename   String
  filesize   Int
  mimetype   String
  url        String
  scanStatus String   @default("pending")
  createdAt  DateTime @default(now())

  incident Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@map("attachments")
}

model FeatureFlag {
  id          String      @id @default(cuid())
  key         String
  tenantId    String
  environment Environment
  enabled     Boolean     @default(false)
  rules       Json
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, key, environment])
  @@map("feature_flags")
}

model AuditLog {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  action    String
  resource  String
  before    Json?
  after     Json?
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id])

  @@index([tenantId, createdAt])
  @@map("audit_logs")
}
